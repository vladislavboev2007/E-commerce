<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–æ–≤–∞—Ä—ã - E-Commerce Store</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">E-Store</div>
            <ul class="nav-links">
                <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/products" class="active">–¢–æ–≤–∞—Ä—ã</a></li>
                <li><a href="/bundles">–ù–∞–±–æ—Ä—ã</a></li>
                <li><a href="/cart">–ö–æ—Ä–∑–∏–Ω–∞</a></li>
                <li><a href="/orders">–ó–∞–∫–∞–∑—ã</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
            <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
            <div style="display: flex; gap: 1rem;">
                <select id="category-filter" onchange="filterProducts()">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." style="padding: 0.8rem;">
                <button class="btn" onclick="searchProducts()">–ü–æ–∏—Å–∫</button>
            </div>
        </div>

        <div id="products-container" class="grid grid-3">
            <div class="spinner"></div>
        </div>

        <div id="pagination" style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 E-Commerce Store. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            <p>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: –ê–¥–∞–ø—Ç–µ—Ä, –î–µ–∫–æ—Ä–∞—Ç–æ—Ä, –ö–æ–º–ø–æ–Ω–æ–≤—â–∏–∫</p>
        </div>
    </footer>

    <script>
        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é - –æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞!
        async function apiCall(endpoint, options = {}) {
            try {
                console.log(`API Call: ${API_BASE}${endpoint}`);
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`API Response from ${endpoint}:`, data);
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
                throw error;
            }
        }

        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é showNotification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        let allProducts = [];
        let currentPage = 1;
        const productsPerPage = 9;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        async function loadAllProducts() {
            try {
                console.log('Loading all products...');
                const products = await apiCall('/products/');
                console.log('All products loaded:', products);

                allProducts = products;
                displayProducts(products);
                loadCategoryFilter(products);
            } catch (error) {
                console.error('Failed to load products:', error);
                const container = document.getElementById('products-container');
                container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function loadCategoryFilter(products) {
            const categories = [...new Set(products.map(p => p.category_name))];
            const filter = document.getElementById('category-filter');

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filter.appendChild(option);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        function displayProducts(products) {
            const container = document.getElementById('products-container');
            const startIndex = (currentPage - 1) * productsPerPage;
            const paginatedProducts = products.slice(startIndex, startIndex + productsPerPage);

            container.innerHTML = '';

            if (paginatedProducts.length === 0) {
                container.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            paginatedProducts.forEach(product => {
                const productCard = `
                    <div class="card">
                        <div style="height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; border-radius: 8px;">
                            <span style="font-size: 2rem;">${getProductIcon(product.category_name)}</span>
                        </div>
                        <h3>${product.name}</h3>
                        <p class="price">$${product.price}</p>
                        <p style="color: #666; margin: 0.5rem 0;">${product.category_name}</p>
                        <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #888;">${product.description}</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" onclick="viewProduct(${product.id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                            <button class="btn btn-success" onclick="addToCart(${product.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });

            setupPagination(products.length);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Ç–æ–≤–∞—Ä–∞
        function getProductIcon(category) {
            const icons = {
                'Electronics': 'üì±',
                'Clothing': 'üëï',
                'Home Appliances': 'üè†'
            };
            return icons[category] || 'üì¶';
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
        function filterProducts() {
            const categoryFilter = document.getElementById('category-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            let filteredProducts = allProducts;

            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category_name === categoryFilter);
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.description.toLowerCase().includes(searchTerm)
                );
            }

            currentPage = 1;
            displayProducts(filteredProducts);
        }

        function searchProducts() {
            filterProducts();
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function setupPagination(totalProducts) {
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            const pagination = document.getElementById('pagination');

            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `btn ${i === currentPage ? '' : 'btn-secondary'}`;
                button.onclick = () => {
                    currentPage = i;
                    displayProducts(allProducts);
                };
                pagination.appendChild(button);
            }
        }

        function viewProduct(productId) {
            window.location.href = `/product?id=${productId}`;
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showNotification('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const existingItem = cart.find(item => item.productId == productId && !item.decorators);

            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.finalPrice = existingItem.basePrice * existingItem.quantity;
            } else {
                cart.push({
                    productId: productId,
                    quantity: 1,
                    productName: product.name,
                    basePrice: parseFloat(product.price),
                    finalPrice: parseFloat(product.price)
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadAllProducts();
        });
    </script>
</body>
</html>